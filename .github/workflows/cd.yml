name: CD

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 ë“±ì˜ íƒœê·¸ í˜•ì‹
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
    
    - name: Get Version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Release Version: ${VERSION}"
    
    - name: Validate Version Format
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "âŒ Error: Version must follow semantic versioning (e.g., v1.0.0)"
          exit 1
        fi
        echo "âœ… Version format validated: ${VERSION}"
    
    - name: Generate Release Notes
      id: release_notes
      run: |
        echo "ðŸ“ Generating release notes..."
        VERSION="${{ steps.get_version.outputs.version }}"
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸŽ‰ InnoFlow ${VERSION}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### What's New" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" --no-merges >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸŽ‰ InnoFlow ${VERSION}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Changes since ${PREV_TAG}" >> $GITHUB_OUTPUT
          git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        echo "âœ… Release notes generated"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: InnoFlow ${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.notes }}
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

