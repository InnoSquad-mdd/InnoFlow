---
description: "Swift Testing 패턴, @Test 매크로, #expect/#require 어설션, 비동기 테스트, 매개변수화된 테스트, TestStore 사용. 테스트 작성 또는 수정, 테스트 스위트 설정 시 적용."
globs: ["Tests/**/*.swift", "**/*Tests.swift", "**/*Test.swift"]
alwaysApply: false
---

# Swift Testing Guidelines for InnoFlow

## Modern Testing with @Test Macros

모든 테스트는 **Swift Testing** 프레임워크를 사용합니다 (XCTest 아님). 테스트는 `Tests/` 디렉토리에 위치합니다.

### Basic Test Structure

```swift
import Testing
import InnoFlow
import InnoFlowTesting

@Test("Counter increments correctly")
func counterIncrement() async {
    let store = TestStore(CounterFeature())
    
    await store.send(.increment) {
        $0.count = 1
    }
}
```

## TestStore 사용

`TestStore`는 InnoFlow 기능을 테스트하기 위한 특수 유틸리티입니다:

### 기본 사용법

```swift
@Test("Increment action updates state")
func testIncrement() async {
    let store = TestStore(CounterFeature())
    
    // Action 전송 및 state 변경 검증
    await store.send(.increment) {
        $0.count = 1
    }
}
```

### 비동기 Effect 테스트

```swift
@Test("Async effect updates state")
func testAsyncEffect() async {
    let mockAPI = MockAPI(user: User(name: "Test"))
    let store = TestStore(UserFeature(api: mockAPI))
    
    // Effect를 트리거하는 action
    await store.send(.load) {
        $0.isLoading = true
    }
    
    // Effect에서 온 action 수신
    await store.receive(._loaded(User(name: "Test"))) {
        $0.user = User(name: "Test")
        $0.isLoading = false
    }
    
    // 처리되지 않은 action이 없는지 확인
    await store.assertNoMoreActions()
}
```

## 필수 패턴

1. **@Test 매크로 사용** - XCTest의 test prefix 대신
2. **#expect 및 #require 사용** - XCTAssert 대신
3. **설명적인 테스트 이름** - 문자열 매개변수로 포함
4. **비동기 코드 테스트** - 적절한 async/await 패턴 사용
5. **#require 사용** - 실패 시 테스트 중단이 필요한 경우

### 주요 Swift Testing 기능

- **@Test**: 테스트 함수 표시 (XCTest의 test prefix 대체)
- **@Suite**: 관련 테스트 그룹화
- **#expect**: 조건 검증 (XCTest의 XCTAssert 대체)
- **#require**: #expect와 유사하지만 실패 시 테스트 실행 중단
- **매개변수화된 테스트**: 데이터 기반 테스트를 위한 @Test와 arguments
- **async/await**: 비동기 코드 테스트 완전 지원
- **Traits**: `.bug()`, `.feature()` 또는 사용자 정의 태그와 같은 메타데이터 추가

## 테스트 구성

### Test Suites

```swift
@Suite("Store Tests")
struct StoreTests {
    
    @Test("State updates correctly")
    func stateUpdates() async {
        let store = TestStore(CounterFeature())
        
        await store.send(.increment) {
            $0.count = 1
        }
        
        await store.send(.increment) {
            $0.count = 2
        }
    }
    
    @Test("Multiple mutations in single action")
    func multipleMutations() async {
        let store = TestStore(ComplexFeature())
        
        await store.send(.updateMultiple) {
            $0.field1 = "value1"
            $0.field2 = 42
            $0.field3 = true
        }
    }
}
```

### 매개변수화된 테스트

```swift
@Test("Counter operations", arguments: [
    (Action.increment, 1),
    (Action.decrement, -1),
    (Action.reset, 0)
])
func counterOperations(action: Action, expectedCount: Int) async {
    let store = TestStore(CounterFeature())
    
    await store.send(action) {
        $0.count = expectedCount
    }
}
```

## 비동기 테스트 패턴

### Effect 테스트

```swift
@Test("Effect returns correct action")
func effectReturnsAction() async {
    let mockService = MockService()
    let store = TestStore(FeatureWithEffect(service: mockService))
    
    // Effect를 트리거하는 action
    await store.send(.triggerEffect) {
        $0.isLoading = true
    }
    
    // Effect에서 반환된 action 수신
    await store.receive(._effectCompleted(result)) {
        $0.isLoading = false
        $0.result = result
    }
    
    // 더 이상 처리할 action이 없음을 확인
    await store.assertNoMoreActions()
}
```

### Stream Effect 테스트

```swift
@Test("Stream effect sends multiple actions")
func streamEffect() async {
    let store = TestStore(StreamFeature())
    
    await store.send(.startStream) {
        $0.isStreaming = true
    }
    
    // 여러 action 수신
    for i in 1...5 {
        await store.receive(._streamUpdate(i)) {
            $0.updates.append(i)
        }
    }
    
    await store.send(.stopStream) {
        $0.isStreaming = false
    }
    
    await store.assertNoMoreActions()
}
```

## TestStore 요구사항

### State: Equatable

`TestStore`를 사용하려면 `State`가 `Equatable`을 준수해야 합니다:

```swift
struct State: Equatable {
    var count: Int
    var name: String
}
```

### Action: Equatable (receive 사용 시)

`receive()` 어설션을 사용하려면 `Action`도 `Equatable`을 준수해야 합니다:

```swift
enum Action: Equatable {
    case increment
    case _loaded(User)  // User도 Equatable이어야 함
}
```

### 항상 assertNoMoreActions() 호출

비동기 테스트의 끝에서 항상 `await store.assertNoMoreActions()`를 호출하세요:

```swift
@Test("Complete async flow")
func completeAsyncFlow() async {
    let store = TestStore(Feature())
    
    await store.send(.load) { ... }
    await store.receive(._loaded) { ... }
    
    // 필수: 처리되지 않은 action 확인
    await store.assertNoMoreActions()
}
```

## 모범 사례

### 테스트 구성
- **소스 파일당 하나의 테스트 파일** (가능한 경우)
- **Happy path와 edge case 모두 테스트**
- **검증하는 내용을 설명하는 설명적인 테스트 이름** 사용
- **테스트 분류를 위한 @Tag 추가** (예: `.unit`, `.integration`)
- **필요한 경우 테스트 메서드에 setup/teardown 포함**

### 테스트 품질
- **단위 테스트를 위해 외부 의존성 모킹**
- **`#expect(throws:)`로 에러 조건 테스트**
- **중요한 전제 조건에 #require 사용**
- **테스트를 단일 동작에 집중**
- **버그 수정에 대한 테스트 추가**하여 회귀 방지

### 의존성 주입

테스트를 위해 mock 서비스를 사용하세요:

```swift
struct MockAPI: APIClient {
    let user: User
    
    func fetchUser() async throws -> User {
        return user
    }
}

@Test("Feature loads user from API")
func featureLoadsUser() async {
    let mockAPI = MockAPI(user: User(name: "Test"))
    let store = TestStore(UserFeature(api: mockAPI))
    
    await store.send(.load) { ... }
    await store.receive(._loaded(User(name: "Test"))) { ... }
    await store.assertNoMoreActions()
}
```

## 매크로 테스트

매크로 확장을 테스트하려면 `SwiftSyntaxMacrosTestSupport`를 사용합니다:

```swift
import SwiftSyntaxMacros
import SwiftSyntaxMacrosTestSupport

@Test("InnoFlow macro expands correctly")
func innoFlowMacroExpansion() {
    assertMacroExpansion(
        """
        @InnoFlow
        struct CounterFeature {
            struct State: Equatable { var count = 0 }
        }
        """,
        expandedSource: """
        // 확장된 코드...
        """,
        macros: testMacros
    )
}
```

## 테스트 실행

테스트는 다음 명령으로 실행할 수 있습니다:

```bash
# 모든 테스트 실행
swift test

# 코드 커버리지와 함께 실행
swift test --enable-code-coverage --parallel

# 특정 테스트 실행
swift test --filter InnoFlowTests.StoreTests.storeIncrement
```

모든 테스트는 이러한 현대적인 Swift Testing 패턴을 따라야 하며 적절한 테스트 타겟 내에 위치해야 합니다.
